import{loadModule}from"/js/module/moduleLoader.js";export async function xf_getHtmlContent(url,onProgress){console.log(`获取 HTML 内容：${url}`);const utils=await loadModule("/js/module/utils.js");return fetch(url).then((response=>{if(!response.ok){throw new Error(`获取 HTML 内容：出错：HTTP：${response.status}`)}const contentLength=response.headers.get("Content-Length");let loaded=0;if(!onProgress){return response.text()}const reader=response.body.getReader();const chunks=[];const total=contentLength?parseInt(contentLength,10):null;return new Promise(((resolve,reject)=>{function read(){reader.read().then((({done:done,value:value})=>{if(done){const html=(new TextDecoder).decode(utils.xf_concatChunks(chunks));resolve(html);return}chunks.push(value);loaded+=value.length;onProgress(loaded,total);read()})).catch(reject)}read()}))})).then((html=>{const parser=new DOMParser;const doc=parser.parseFromString(html,"text/html");return doc.body.firstElementChild})).catch((e=>{console.error("获取 HTML 内容：出错：",e);const errorElement=document.createElement("span");errorElement.textContent=`获取 HTML 内容：出错：${e.message}`;return errorElement}))}export function xf_loadHtmlContent(htmlContent,container){console.log(`加载 HTML 内容到指定容器：容器：${container.id}`);try{while(container.firstChild){container.firstChild.remove()}container.appendChild(htmlContent)}catch(e){console.error("加载 HTML 内容到指定容器：出错：",e);const errorElement=document.createElement("span");errorElement.textContent=`加载 HTML 内容到指定容器：出错：${e.message}`;container.appendChild(errorElement)}}export async function xf_loadHtmlContentFromUrl(url,container){console.log(`获取并加载 HTML 内容到指定容器：内容：${url}；容器：${container.id}`);const utils=await loadModule("/js/module/utils.js");try{const loadingElement=document.createElement("div");loadingElement.className="xf-loading";loadingElement.id="xf-loading-progress";loadingElement.innerHTML="正在加载<br>?%<br>0 / ?";container.innerHTML="";container.appendChild(loadingElement);const htmlContent=await xf_getHtmlContent(url,((loaded,total)=>{const percent=total?Math.round(loaded/total*100):0;const loadedFormatted=utils.xf_formatBytes(loaded);const totalFormatted=total?utils.xf_formatBytes(total):"?";const progressElement=document.getElementById("xf-loading-progress");if(progressElement){progressElement.innerHTML=`正在加载<br>${percent}%<br>${loadedFormatted} / ${totalFormatted}`}}));if(htmlContent){xf_loadHtmlContent(htmlContent,container)}mdui.mutation()}catch(e){console.error("获取并加载 HTML 内容到指定容器：",e);container.innerHTML=`<div class="xf-error-text">获取并加载 HTML 内容到指定容器：出错：${e.message}</div>`}}export async function fetchItems(source,responseType="json"){if(typeof source==="string"){try{const response=await fetch(source);if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}return await response[responseType]()}catch(error){if(error.name==="TypeError"){throw new Error(`网络错误：${error.message}`)}throw error}}return source}