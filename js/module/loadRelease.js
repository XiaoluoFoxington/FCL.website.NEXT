import{loadModule}from"/js/module/moduleLoader.js";export async function loadReleaseHistory(repoFullName,targetElementId){console.log("加载Release历史：",repoFullName,targetElementId);try{await async function(){try{if(!function(repoFullName){if("string"!=typeof repoFullName)return!1;const parts=repoFullName.split("/");if(2!==parts.length)return!1;const[owner,repo]=parts;return""!==owner.trim()&&""!==repo.trim()}(repoFullName))return void onError("仓库全名非法");const containerElement=document.getElementById(targetElementId);if(!containerElement)return void onError("目标元素不存在");const releaseData=await async function(repoFullName){const apiUrl=`https://api.github.com/repos/${repoFullName}/releases`,response=await fetch(apiUrl);if(!response.ok){const errorMsg={404:"404：找不到仓库",403:"403：API请求超限",500:"500：GH内部错误"}[response.status]||`${response.status}：${response.statusText}`;throw new Error(errorMsg)}return await response.json()}(repoFullName);if(0===releaseData.length)return void onError("没有Release数据");!function(releases,container){container.innerHTML="";const panelContainer=document.createElement("div");panelContainer.id="release-panel-container",panelContainer.classList.add("mdui-panel"),panelContainer.setAttribute("mdui-panel","");const fragment=document.createDocumentFragment();releases.forEach(((release,index)=>{const panelHtml=`\n        <div class="mdui-panel-item ${0===index?"mdui-panel-item-open":""}" id="release-panel-${index}">\n          <div class="mdui-panel-item-header mdui-ripple">\n            <div class="mdui-panel-item-title">${release.name||"未命名版本"}</div>\n            <div class="mdui-panel-item-summary">${release.tag_name}</div>\n            <div class="mdui-panel-item-summary">${new Date(release.published_at).toLocaleString()}</div>\n            <i class="mdui-panel-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>\n          </div>\n          <div class="mdui-panel-item-body mdui-typo">\n            ${marked.parse(release.body||"无发布说明")}\n          </div>\n        </div>`,panelElementWrapper=document.createElement("div");panelElementWrapper.innerHTML=panelHtml,fragment.appendChild(panelElementWrapper.firstElementChild)})),panelContainer.appendChild(fragment),container.appendChild(panelContainer),mdui.mutation()}(releaseData,containerElement)}catch(error){onError(error)}}()}catch(error){onError(error)}function onError(e){const fullErrorMessage="加载Release历史：出错："+("string"==typeof e?e:e.message);e instanceof Error?console.error(fullErrorMessage,e):console.error(fullErrorMessage);const containerElement=document.getElementById(targetElementId);containerElement&&(containerElement.innerHTML=`\n      <div class="mdui-panel" mdui-panel>\n        <div class="mdui-panel-item mdui-panel-item-open" style="background-color: #ff000040;">\n          <div class="mdui-panel-item-header mdui-ripple">\n            <div>加载出错</div>\n            <i class="mdui-panel-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>\n          </div>\n          <div class="mdui-panel-item-body mdui-typo">\n            <p>${fullErrorMessage}</p>\n          </div>\n        </div>\n      </div>`,mdui.mutation())}}