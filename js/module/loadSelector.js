export function loadSelector(options){const{containerId:containerId,dataSource:dataSource,disableDebounce:disableDebounce=!1,debounceDelay:debounceDelay=10,onCreateSelectElement:onCreateSelectElement=defaultCreateSelectElement,onCreateDescriptionElement:onCreateDescriptionElement=defaultCreateDescriptionElement,onCreateDownloadElement:onCreateDownloadElement=defaultCreateDownloadElement,onItemSelect:onItemSelect,onDownload:onDownload,onRenderError:onRenderError=defaultRenderError,onLevelChange:onLevelChange,transformWay2oldApiData:transformWay2oldApiData=defaultTransformWay2oldApiData,transformLemwoodApiData:transformLemwoodApiData=defaultTransformLemwoodApiData,transformLemwoodLatestApiData:transformLemwoodLatestApiData=defaultTransformLemwoodLatestApiData}=options,container=document.getElementById(containerId);async function loadLevel(source,level){console.log(`选择器模块：加载层级 ${level}：`,source),clearLevelElements(level);try{const items=await fetchItems(source);!function(items){if(!Array.isArray(items))throw new Error("返回数据不是数组")}(items);const isBottom=function(items){if(!items||!Array.isArray(items)||0===items.length)return!0;return!items.some((item=>item.children&&Array.isArray(item.children)&&item.children.length>0||item.nextUrl&&"string"==typeof item.nextUrl))}(items);console.log(`选择器模块：层级 ${level} 是否为最底层：`,isBottom),isBottom?renderDownloadButtons(items,level):function(items,level){const select=onCreateSelectElement(items,level),descDiv=onCreateDescriptionElement();(function(select,items,level,descDiv){select.addEventListener("change",(async()=>{const selectedIndex=parseInt(select.value);if(descDiv.innerHTML="",isNaN(selectedIndex)||selectedIndex<0||selectedIndex>=items.length)return;const selectedItem=items[selectedIndex];if(console.log("选择器模块：当前选择项名称："+selectedItem.name),selectedItem.description&&(descDiv.innerHTML=selectedItem.description),onItemSelect){if(onItemSelect(selectedItem,level))return}await async function(selectedItem,nextLevel,descDiv){const{children:children,nextUrl:nextUrl,url:url,items:itemArray,apiVer:apiVer}=selectedItem;if(children&&Array.isArray(children)){console.log(`选择器模块：${selectedItem.name}：有children`);loadLevel(transformDataIfNecessary(children,apiVer),nextLevel)}else if(nextUrl){console.log(`选择器模块：${selectedItem.name}：有nextUrl`);try{const rawData=await fetchItems(nextUrl);loadLevel(transformDataIfNecessary(rawData,apiVer),nextLevel)}catch(error){console.error(`选择器模块：加载层级 ${nextLevel}：获取数据出错：`,error),onRenderError(error.message,nextLevel,container)}}else url?(console.log("选择器模块：层级处理单个下载项：",selectedItem),renderDownloadButtons([selectedItem],nextLevel)):itemArray&&Array.isArray(itemArray)?(console.log("选择器模块：层级处理多个下载项：",selectedItem),renderDownloadButtons(itemArray,nextLevel)):(selectedItem.description||(descDiv.innerHTML='<div class="mdui-typo"><p>此层级既无下一级数据，也无描述信息。</p></div>'),clearLevelElements(nextLevel))}(selectedItem,level+1,descDiv),onLevelChange&&onLevelChange(level+1)}))})(select,items,level,descDiv),container.appendChild(select),container.appendChild(descDiv),function(select,items,level){if(0===items.length)return;const defaultIndex=items.findIndex((item=>!0===item.default)),autoSelectIndex=-1!==defaultIndex?defaultIndex:0;console.log(`选择器模块：层级 ${level}：原始索引：${defaultIndex}`),console.log(`选择器模块：层级 ${level}：自动选择索引：${autoSelectIndex}`),select.value=autoSelectIndex.toString();const event=new Event("change",{bubbles:!0});select.dispatchEvent(event)}(select,items,level)}(items,level)}catch(error){console.error(`选择器模块：加载层级 ${level} 出错：`,error),onRenderError(error.message,level,container)}}function clearLevelElements(level){for(;container.children.length>2*level;)container.removeChild(container.lastChild)}async function fetchItems(source,responseType="json"){if("string"==typeof source)try{const response=await fetch(source);if(!response.ok)throw new Error(`HTTP ${response.status}: ${response.statusText}`);return await response[responseType]()}catch(error){if("TypeError"===error.name)throw new Error(`网络错误：${error.message}`);throw error}return source}async function transformDataIfNecessary(data,apiVer){switch(apiVer){case"Way2old":const latestWay2old=function(data){return console.log(`选择器模块：Way2old线：latest：${data.latest}`),data.latest}(data);return transformWay2oldApiData(data,latestWay2old);case"Lemwood":const latestLemwood=await async function(){const firstSelect=container.firstElementChild;if(!firstSelect||!firstSelect.selectedOptions||0===firstSelect.selectedOptions.length)return console.error("选择器模块：Lemwood线：无法获取第一个选择器的选中项"),null;let selectName=firstSelect.selectedOptions[0].innerText;switch(selectName){case"Fold Craft Launcher":selectName="fcl";break;case"Zalith Launcher":selectName="zl";break;case"Zalith Launcher 2":selectName="zl2";break;case"HMCL":selectName="hmcl";break;default:return console.warn(`选择器模块：Lemwood线：未知选择器名称：${selectName}`),null}const latest=await fetchItems(`https://mirror.lemwood.icu/api/latest/${selectName}`,"text");return console.log(`选择器模块：Lemwood线：latest：${latest}`),latest}();return transformLemwoodApiData(data,latestLemwood);case"LemwoodLatest":return transformLemwoodLatestApiData(data);default:return data}}function renderDownloadButtons(items,level){console.log(`选择器模块：渲染下载按钮，数量：${items.length}`),clearLevelElements(level);const buttonsContainer=document.createElement("div");buttonsContainer.className="download-buttons-container",items.forEach((item=>{if(item.url){const link=onCreateDownloadElement(item,onDownload,disableDebounce?0:debounceDelay);buttonsContainer.appendChild(link)}})),container.appendChild(buttonsContainer)}function defaultCreateSelectElement(items,level){const select=document.createElement("select");select.classList.add("mdui-select","mdui-block");const fragment=document.createDocumentFragment(),groupOptions={};items.forEach(((item,index)=>{const option=document.createElement("option");option.value=index,option.textContent=item.name||"(无名称)";const groupName=item.type||"";groupOptions[groupName]||(groupOptions[groupName]=[]),groupOptions[groupName].push(option)}));for(const[groupName,options]of Object.entries(groupOptions))if(groupName){const optgroup=document.createElement("optgroup");optgroup.label=groupName,options.forEach((option=>optgroup.appendChild(option))),fragment.appendChild(optgroup)}else options.forEach((option=>fragment.appendChild(option)));return select.appendChild(fragment),select}function defaultCreateDescriptionElement(){const descDiv=document.createElement("div");return descDiv.className="description",descDiv}function defaultCreateDownloadElement(item,onDownload,debounceDelay){const link=document.createElement("a");link.href=item.url;let displayName=item.name||"文件";"all 架构"===displayName&&(displayName="通用架构");const originalText=`下载 ${displayName}`;link.textContent=originalText,link.className="mdui-btn mdui-btn-block mdui-btn-raised mdui-ripple",link.target="_blank",link.dataset.originalText=originalText,link.dataset.debounceDelay=debounceDelay;return link.addEventListener("click",(e=>{link.disabled?e.preventDefault():(onDownload&&onDownload(item,e),function(link){const debounceDelay=parseInt(link.dataset.debounceDelay)||3;if(debounceDelay<=0)return;let remainingTime=debounceDelay;link.disabled=!0,link.style.opacity="0.5",link.style.cursor="not-allowed",link.textContent=`请勿重复点击：${remainingTime}秒`;const timer=setInterval((()=>{remainingTime--,remainingTime>0?link.textContent=`请勿重复点击：${remainingTime}秒`:(clearInterval(timer),link.disabled=!1,link.style.opacity="1",link.style.cursor="pointer",link.textContent=link.dataset.originalText)}),1e3)}(link))})),link}function defaultRenderError(message,level,container){const errorEl=document.createElement("div");errorEl.style.color="#f00",errorEl.textContent=`出错：${message}`,container.appendChild(errorEl)}function defaultTransformWay2oldApiData(data,latest){const result=[];return(Array.isArray(data)?data:data.children||[]).forEach((item=>{"directory"===item.type?result.push({name:item.name,description:item.description||"",children:item.children?defaultTransformWay2oldApiData(item.children,latest):[],default:item.name===latest}):"file"===item.type?result.push({name:item.arch+" 架构",url:item.download_link,arch:item.arch||""}):console.warn("选择器模块：转换Way2old：忽略未知类型项：",item)})),result}function defaultTransformLemwoodApiData(data,latest){return data.map((item=>({name:item.name,default:item.name===latest,children:item.assets?.map((asset=>({name:asset.name,url:asset.url,size:asset.size})))||[]})))}function defaultTransformLemwoodLatestApiData(data){return defaultTransformLemwoodApiData([data])}container?loadLevel(dataSource,0):console.error(`选择器模块：找不到容器：${containerId}`)}