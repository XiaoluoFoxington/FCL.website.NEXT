import{loadModule}from"/js/module/moduleLoader.js";export async function loadSelector(options){const{containerId:containerId,dataSource:dataSource,sourceApiVer:sourceApiVer,disableDebounce:disableDebounce=false,debounceDelay:debounceDelay=10,onCreateSelectElement:onCreateSelectElement=defaultCreateSelectElement,onCreateDescriptionElement:onCreateDescriptionElement=defaultCreateDescriptionElement,onCreateDownloadElement:onCreateDownloadElement=defaultCreateDownloadElement,onItemSelect:onItemSelect,onDownload:onDownload,onRenderError:onRenderError=defaultRenderError,onLevelChange:onLevelChange}=options;let rootDataTransform=sourceApiVer;const container=document.getElementById(containerId);if(!container){console.error(`选择器模块：找不到容器：${containerId}`);return}loadLevel(dataSource,0);async function loadLevel(source,level){const loadContent=await loadModule("/js/module/loadContent.js");const transformApiData=await loadModule("/js/module/transformApiData.js");console.log(`选择器模块：加载层级 ${level}：`,source);clearLevelElements(level);try{const Sourceitems=await loadContent.fetchItems(source);const items=await transformApiData.transformDataIfNecessary(Sourceitems,rootDataTransform,container);rootDataTransform=undefined;validateItems(items);const isBottom=isBottomLevel(items);console.log(`选择器模块：层级 ${level} 是否为最底层：`,isBottom);if(isBottom){renderDownloadButtons(items,level);enableAllSelects()}else{renderSelect(items,level)}}catch(error){console.error(`选择器模块：加载层级 ${level} 出错：`,error);onRenderError(error.message,level,container)}}function isBottomLevel(items){if(!items||!Array.isArray(items)||items.length===0){return true}return!items.some((item=>item.children&&Array.isArray(item.children)&&item.children.length>0||item.nextUrl&&typeof item.nextUrl==="string"))}function clearLevelElements(level){while(container.children.length>level*2){container.removeChild(container.lastChild)}}function validateItems(items){if(!Array.isArray(items)){console.warn("选择器模块：验证数据格式：数据不是数组");return false}return true}function renderSelect(items,level){const select=onCreateSelectElement(items,level);const descDiv=onCreateDescriptionElement();addSelectEventListeners(select,items,level,descDiv);container.appendChild(select);container.appendChild(descDiv);autoSelectOption(select,items,level)}async function addSelectEventListeners(select,items,level,descDiv){select.addEventListener("change",(async()=>{disableAllSelects();const loadContent=await loadModule("/js/module/loadContent.js");const selectedIndex=parseInt(select.value);descDiv.innerHTML="";if(isNaN(selectedIndex)||selectedIndex<0||selectedIndex>=items.length){return}const selectedItem=items[selectedIndex];console.log("选择器模块：当前选择项名称："+selectedItem.name);if(selectedItem.description){descDiv.innerHTML=selectedItem.description;bottomEnableAllSelects(items,selectedIndex)}if(selectedItem.desUrl){const content=await loadContent.fetchItems(selectedItem.desUrl,"text");descDiv.innerHTML=content;if(selectedItem.desJsUrl){const scriptEl=document.createElement("script");scriptEl.src=selectedItem.desJsUrl;descDiv.appendChild(scriptEl)}bottomEnableAllSelects(items,selectedIndex)}if(onItemSelect){const result=onItemSelect(selectedItem,level);if(result)return}await handleItemSelection(selectedItem,level+1,descDiv);if(onLevelChange){onLevelChange(level+1)}}))}function bottomEnableAllSelects(items,selectedIndex){if(isBottomLevel(items[selectedIndex])){enableAllSelects()}}async function handleItemSelection(selectedItem,nextLevel,descDiv){const loadContent=await loadModule("/js/module/loadContent.js");const transformApiData=await loadModule("/js/module/transformApiData.js");const{children:children,nextUrl:nextUrl,url:url,items:itemArray,apiVer:apiVer,random:random}=selectedItem;if(children&&Array.isArray(children)){console.log(`选择器模块：${selectedItem.name}：有children`);const transformedData=await transformApiData.transformDataIfNecessary(children,apiVer,container,random);loadLevel(transformedData,nextLevel)}else if(nextUrl){console.log(`选择器模块：${selectedItem.name}：有nextUrl`);try{const rawData=await loadContent.fetchItems(nextUrl);const transformedData=await transformApiData.transformDataIfNecessary(rawData,apiVer,container,random);loadLevel(transformedData,nextLevel)}catch(error){console.error(`选择器模块：加载层级 ${nextLevel}：获取数据出错：`,error);onRenderError(error.message,nextLevel,container)}}else if(itemArray&&Array.isArray(itemArray)){console.log(`选择器模块：层级处理多个下载项：`,selectedItem);renderDownloadButtons(itemArray,nextLevel)}else if(url){console.log(`选择器模块：层级处理单个下载项：`,selectedItem);renderDownloadButtons([selectedItem],nextLevel)}else{if(!selectedItem.description&&!selectedItem.desUrl){descDiv.innerHTML='<div class="mdui-typo"><p>此层级既无下一级数据，也无描述信息。</p></div>'}clearLevelElements(nextLevel)}}function autoSelectOption(select,items,level){if(items.length===0)return;const defaultIndex=items.findIndex((item=>item.default===true));const autoSelectIndex=defaultIndex!==-1?defaultIndex:0;console.log(`选择器模块：层级 ${level}：原始索引：${defaultIndex}`);console.log(`选择器模块：层级 ${level}：自动选择索引：${autoSelectIndex}`);select.value=autoSelectIndex.toString();const event=new Event("change",{bubbles:true});select.dispatchEvent(event)}function renderDownloadButtons(items,level){console.log(`选择器模块：渲染下载按钮，数量：${items.length}`);clearLevelElements(level);const buttonsContainer=document.createElement("div");buttonsContainer.className="download-buttons-container";items.forEach((item=>{if(item.url){const delayToUse=disableDebounce?0:debounceDelay;const link=onCreateDownloadElement(item,onDownload,delayToUse);buttonsContainer.appendChild(link)}}));container.appendChild(buttonsContainer);enableAllSelects()}function disableAllSelects(){console.log("选择器模块：禁用全部下拉选择框");const selects=container.querySelectorAll("select");selects.forEach((select=>{select.disabled=true}))}function enableAllSelects(){console.log("选择器模块：启用全部下拉选择框");const selects=container.querySelectorAll("select");selects.forEach((select=>{select.disabled=false}))}function defaultCreateSelectElement(items,level){const select=document.createElement("select");select.classList.add("mdui-select","mdui-block");const fragment=document.createDocumentFragment();const groupOptions={};items.forEach(((item,index)=>{const option=document.createElement("option");option.value=index;option.textContent=item.name||"(无名称)";const groupName=item.type||"";if(!groupOptions[groupName]){groupOptions[groupName]=[]}groupOptions[groupName].push(option)}));for(const[groupName,options]of Object.entries(groupOptions)){if(groupName){const optgroup=document.createElement("optgroup");optgroup.label=groupName;options.forEach((option=>optgroup.appendChild(option)));fragment.appendChild(optgroup)}else{options.forEach((option=>fragment.appendChild(option)))}}select.appendChild(fragment);return select}function defaultCreateDescriptionElement(){const descDiv=document.createElement("div");descDiv.className="description";return descDiv}function defaultCreateDownloadElement(item,onDownload,debounceDelay){const link=document.createElement("a");link.href=item.url;let displayName=item.name||"文件";if(displayName==="all 架构"){displayName="通用 架构"}const originalText=`${displayName}`;link.textContent=originalText;link.className="mdui-btn mdui-btn-block mdui-btn-raised mdui-ripple";link.target="_blank";link.dataset.originalText=originalText;link.dataset.debounceDelay=debounceDelay;const handleClick=e=>{if(link.disabled){e.preventDefault();return}if(onDownload){onDownload(item,e)}startCountdown(link)};link.addEventListener("click",handleClick);return link}function startCountdown(link){const debounceDelay=parseInt(link.dataset.debounceDelay)||3;if(debounceDelay<=0){return}let remainingTime=debounceDelay;link.disabled=true;link.style.opacity="0.5";link.style.cursor="not-allowed";link.textContent=`请勿重复点击：${remainingTime}秒`;const timer=setInterval((()=>{remainingTime--;if(remainingTime>0){link.textContent=`请勿重复点击：${remainingTime}秒`}else{clearInterval(timer);link.disabled=false;link.style.opacity="1";link.style.cursor="pointer";link.textContent=link.dataset.originalText}}),1e3)}function debounce(func,delay){let timeoutId;return function(...args){const context=this;clearTimeout(timeoutId);timeoutId=setTimeout((()=>func.apply(context,args)),delay*1e3)}}function defaultRenderError(message,level,container){enableAllSelects();clearLevelElements(level);const errorEl=document.createElement("div");errorEl.style.color="#f00";errorEl.textContent=`出错：${message}`;container.appendChild(errorEl)}}