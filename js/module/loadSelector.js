import{loadModule}from"/js/module/moduleLoader.js";export function loadSelector(options){const{containerId:containerId,dataSource:dataSource,disableDebounce:disableDebounce=false,debounceDelay:debounceDelay=10,onCreateSelectElement:onCreateSelectElement=defaultCreateSelectElement,onCreateDescriptionElement:onCreateDescriptionElement=defaultCreateDescriptionElement,onCreateDownloadElement:onCreateDownloadElement=defaultCreateDownloadElement,onItemSelect:onItemSelect,onDownload:onDownload,onRenderError:onRenderError=defaultRenderError,onLevelChange:onLevelChange,transformWay2oldApiData:transformWay2oldApiData=defaultTransformWay2oldApiData,transformLemwoodApiData:transformLemwoodApiData=defaultTransformLemwoodApiData,transformLemwoodLatestApiData:transformLemwoodLatestApiData=defaultTransformLemwoodLatestApiData}=options;const container=document.getElementById(containerId);if(!container){console.error(`选择器模块：找不到容器：${containerId}`);return}loadLevel(dataSource,0);async function loadLevel(source,level){const loadContent=await loadModule("/js/module/loadContent.js");console.log(`选择器模块：加载层级 ${level}：`,source);clearLevelElements(level);try{const items=await loadContent.fetchItems(source);validateItems(items);const isBottom=isBottomLevel(items);console.log(`选择器模块：层级 ${level} 是否为最底层：`,isBottom);if(isBottom){renderDownloadButtons(items,level);enableAllSelects()}else{renderSelect(items,level)}}catch(error){console.error(`选择器模块：加载层级 ${level} 出错：`,error);onRenderError(error.message,level,container)}}function isBottomLevel(items){if(!items||!Array.isArray(items)||items.length===0){return true}return!items.some((item=>item.children&&Array.isArray(item.children)&&item.children.length>0||item.nextUrl&&typeof item.nextUrl==="string"))}function clearLevelElements(level){while(container.children.length>level*2){container.removeChild(container.lastChild)}}function validateItems(items){if(!Array.isArray(items)){throw new Error("返回数据不是数组")}}function renderSelect(items,level){const select=onCreateSelectElement(items,level);const descDiv=onCreateDescriptionElement();addSelectEventListeners(select,items,level,descDiv);container.appendChild(select);container.appendChild(descDiv);autoSelectOption(select,items,level)}async function addSelectEventListeners(select,items,level,descDiv){select.addEventListener("change",(async()=>{disableAllSelects();const loadContent=await loadModule("/js/module/loadContent.js");const selectedIndex=parseInt(select.value);descDiv.innerHTML="";if(isNaN(selectedIndex)||selectedIndex<0||selectedIndex>=items.length){return}const selectedItem=items[selectedIndex];console.log("选择器模块：当前选择项名称："+selectedItem.name);if(selectedItem.description){descDiv.innerHTML=selectedItem.description;bottomEnableAllSelects(items,selectedIndex)}if(selectedItem.desUrl){const content=await loadContent.fetchItems(selectedItem.desUrl,"text");descDiv.innerHTML=content;if(selectedItem.desJsUrl){const scriptEl=document.createElement("script");scriptEl.src=selectedItem.desJsUrl;descDiv.appendChild(scriptEl)}bottomEnableAllSelects(items,selectedIndex)}if(onItemSelect){const result=onItemSelect(selectedItem,level);if(result)return}await handleItemSelection(selectedItem,level+1,descDiv);if(onLevelChange){onLevelChange(level+1)}}))}function bottomEnableAllSelects(items,selectedIndex){if(isBottomLevel(items[selectedIndex])){enableAllSelects()}}async function handleItemSelection(selectedItem,nextLevel,descDiv){const loadContent=await loadModule("/js/module/loadContent.js");const{children:children,nextUrl:nextUrl,url:url,items:itemArray,apiVer:apiVer}=selectedItem;if(children&&Array.isArray(children)){console.log(`选择器模块：${selectedItem.name}：有children`);const transformedData=transformDataIfNecessary(children,apiVer);loadLevel(transformedData,nextLevel)}else if(nextUrl){console.log(`选择器模块：${selectedItem.name}：有nextUrl`);try{const rawData=await loadContent.fetchItems(nextUrl);const transformedData=transformDataIfNecessary(rawData,apiVer);loadLevel(transformedData,nextLevel)}catch(error){console.error(`选择器模块：加载层级 ${nextLevel}：获取数据出错：`,error);onRenderError(error.message,nextLevel,container)}}else if(itemArray&&Array.isArray(itemArray)){console.log(`选择器模块：层级处理多个下载项：`,selectedItem);renderDownloadButtons(itemArray,nextLevel)}else if(url){console.log(`选择器模块：层级处理单个下载项：`,selectedItem);renderDownloadButtons([selectedItem],nextLevel)}else{if(!selectedItem.description&&!selectedItem.desUrl){descDiv.innerHTML='<div class="mdui-typo"><p>此层级既无下一级数据，也无描述信息。</p></div>'}clearLevelElements(nextLevel)}}async function transformDataIfNecessary(data,apiVer){switch(apiVer){case"Way2old":const latestWay2old=await getWay2oldApiLatestVersion(data);return transformWay2oldApiData(data,latestWay2old);case"Lemwood":const latestLemwood=await getLemwoodApiLatestVersion();return transformLemwoodApiData(data,latestLemwood);case"LemwoodLatest":return transformLemwoodLatestApiData(data);default:return data}}function autoSelectOption(select,items,level){if(items.length===0)return;const defaultIndex=items.findIndex((item=>item.default===true));const autoSelectIndex=defaultIndex!==-1?defaultIndex:0;console.log(`选择器模块：层级 ${level}：原始索引：${defaultIndex}`);console.log(`选择器模块：层级 ${level}：自动选择索引：${autoSelectIndex}`);select.value=autoSelectIndex.toString();const event=new Event("change",{bubbles:true});select.dispatchEvent(event)}function renderDownloadButtons(items,level){console.log(`选择器模块：渲染下载按钮，数量：${items.length}`);clearLevelElements(level);const buttonsContainer=document.createElement("div");buttonsContainer.className="download-buttons-container";items.forEach((item=>{if(item.url){const delayToUse=disableDebounce?0:debounceDelay;const link=onCreateDownloadElement(item,onDownload,delayToUse);buttonsContainer.appendChild(link)}}));container.appendChild(buttonsContainer)}async function getWay2oldApiLatestVersion(data){const loadContent=await loadModule("/js/module/loadContent.js");const repoMap={"Fold Craft Launcher":"FCL-Team/FoldCraftLauncher","Zalith Launcher 2":"ZalithLauncher/ZalithLauncher2"};console.log(`选择器模块：Way2Old线：latest：通过原始数据获取：${data.latest}`);const firstSelect=container.firstElementChild;if(!firstSelect||!firstSelect.selectedOptions||firstSelect.selectedOptions.length===0){console.error("选择器模块：Way2Old线：无法获取第一个选择器的选中项");return null}let selectName=firstSelect.selectedOptions[0].innerText;selectName=repoMap[selectName]||selectName;const repoRelInfo=await loadContent.fetchItems(`https://api.github.com/repos/${selectName}/releases`,"json");const latest=repoRelInfo[0].tag_name;if(latest){console.log(`选择器模块：Way2Old线：latest：通过GH获取成功，将忽略原始数据。`);console.log(`选择器模块：Way2Old线：latest：通过GH获取：${latest}`);return latest}else{return data.latest}}async function getLemwoodApiLatestVersion(){const loadContent=await loadModule("/js/module/loadContent.js");const apiMap={"Fold Craft Launcher":"fcl","Zalith Launcher":"zl","Zalith Launcher 2":"zl2",HMCL:"hmcl","Vulkan 驱动":"FCL_Turnip","渲染器":"MG"};const firstSelect=container.firstElementChild;if(!firstSelect||!firstSelect.selectedOptions||firstSelect.selectedOptions.length===0){console.error("选择器模块：Lemwood线：无法获取第一个选择器的选中项");return null}let selectName=firstSelect.selectedOptions[0].innerText;selectName=apiMap[selectName]||selectName;const latest=await loadContent.fetchItems(`https://mirror.lemwood.icu/api/latest/${selectName}`,"text");console.log(`选择器模块：Lemwood线：latest：${latest}`);return latest}function disableAllSelects(){console.log("选择器模块：禁用全部下拉选择框");const selects=container.querySelectorAll("select");selects.forEach((select=>{select.disabled=true}))}function enableAllSelects(){console.log("选择器模块：启用全部下拉选择框");const selects=container.querySelectorAll("select");selects.forEach((select=>{select.disabled=false}))}function defaultCreateSelectElement(items,level){const select=document.createElement("select");select.classList.add("mdui-select","mdui-block");const fragment=document.createDocumentFragment();const groupOptions={};items.forEach(((item,index)=>{const option=document.createElement("option");option.value=index;option.textContent=item.name||"(无名称)";const groupName=item.type||"";if(!groupOptions[groupName]){groupOptions[groupName]=[]}groupOptions[groupName].push(option)}));for(const[groupName,options]of Object.entries(groupOptions)){if(groupName){const optgroup=document.createElement("optgroup");optgroup.label=groupName;options.forEach((option=>optgroup.appendChild(option)));fragment.appendChild(optgroup)}else{options.forEach((option=>fragment.appendChild(option)))}}select.appendChild(fragment);return select}function defaultCreateDescriptionElement(){const descDiv=document.createElement("div");descDiv.className="description";return descDiv}function defaultCreateDownloadElement(item,onDownload,debounceDelay){const link=document.createElement("a");link.href=item.url;let displayName=item.name||"文件";if(displayName==="all 架构"){displayName="通用架构"}const originalText=`下载 ${displayName}`;link.textContent=originalText;link.className="mdui-btn mdui-btn-block mdui-btn-raised mdui-ripple";link.target="_blank";link.dataset.originalText=originalText;link.dataset.debounceDelay=debounceDelay;const handleClick=e=>{if(link.disabled){e.preventDefault();return}if(onDownload){onDownload(item,e)}startCountdown(link)};link.addEventListener("click",handleClick);return link}function startCountdown(link){const debounceDelay=parseInt(link.dataset.debounceDelay)||3;if(debounceDelay<=0){return}let remainingTime=debounceDelay;link.disabled=true;link.style.opacity="0.5";link.style.cursor="not-allowed";link.textContent=`请勿重复点击：${remainingTime}秒`;const timer=setInterval((()=>{remainingTime--;if(remainingTime>0){link.textContent=`请勿重复点击：${remainingTime}秒`}else{clearInterval(timer);link.disabled=false;link.style.opacity="1";link.style.cursor="pointer";link.textContent=link.dataset.originalText}}),1e3)}function debounce(func,delay){let timeoutId;return function(...args){const context=this;clearTimeout(timeoutId);timeoutId=setTimeout((()=>func.apply(context,args)),delay*1e3)}}function defaultRenderError(message,level,container){enableAllSelects();clearLevelElements(level);const errorEl=document.createElement("div");errorEl.style.color="#f00";errorEl.textContent=`出错：${message}`;container.appendChild(errorEl)}function defaultTransformWay2oldApiData(data,latest){const result=[];const itemsToProcess=Array.isArray(data)?data:data.children||[];itemsToProcess.forEach((item=>{if(item.type==="directory"){result.push({name:item.name,description:item.description||"",children:item.children?defaultTransformWay2oldApiData(item.children,latest):[],default:item.name===latest})}else if(item.type==="file"){result.push({name:item.arch+" 架构",url:item.download_link,arch:item.arch||""})}else{console.warn("选择器模块：转换Way2old：忽略未知类型项：",item)}}));return result}function defaultTransformLemwoodApiData(data,latest){return data.map((item=>({name:item.name,default:item.name===latest,children:item.assets?.map((asset=>({name:asset.name,url:asset.url,size:asset.size})))||[]})))}function defaultTransformLemwoodLatestApiData(data){return defaultTransformLemwoodApiData([data])}}