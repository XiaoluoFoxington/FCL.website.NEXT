export function loadSelector(e){const{containerId:t,dataSource:n,disableDebounce:o=!1,debounceDelay:a=10,onCreateSelectElement:r=defaultCreateSelectElement,onCreateDescriptionElement:l=defaultCreateDescriptionElement,onCreateDownloadElement:s=defaultCreateDownloadElement,onItemSelect:c,onDownload:i,onRenderError:d=defaultRenderError,onLevelChange:u,transformWay2oldApiData:m=defaultTransformWay2oldApiData,transformLemwoodApiData:f=defaultTransformLemwoodApiData,transformLemwoodLatestApiData:p=defaultTransformLemwoodLatestApiData}=e,h=document.getElementById(t);async function loadLevel(e,t){console.log(`选择器模块：加载层级 ${t}：`,e),clearLevelElements(t);try{const n=await fetchItems(e);!function(e){if(!Array.isArray(e))throw new Error("返回数据不是数组")}(n);const o=function(e){if(!e||!Array.isArray(e)||0===e.length)return!0;return!e.some((e=>e.children&&Array.isArray(e.children)&&e.children.length>0||e.nextUrl&&"string"==typeof e.nextUrl))}(n);console.log(`选择器模块：层级 ${t} 是否为最底层：`,o),o?renderDownloadButtons(n,t):function(e,t){const n=r(e,t),o=l();(function(e,t,n,o){e.addEventListener("change",(async()=>{const a=parseInt(e.value);if(o.innerHTML="",isNaN(a)||a<0||a>=t.length)return;const r=t[a];if(console.log("选择器模块：当前选择项名称："+r.name),r.description&&(o.innerHTML=r.description),c){if(c(r,n))return}await async function(e,t,n){const{children:o,nextUrl:a,url:r,items:l,apiVer:s}=e;if(o&&Array.isArray(o)){console.log(`选择器模块：${e.name}：有children`);loadLevel(transformDataIfNecessary(o,s),t)}else if(a){console.log(`选择器模块：${e.name}：有nextUrl`);try{const e=await fetchItems(a);loadLevel(transformDataIfNecessary(e,s),t)}catch(e){console.error(`选择器模块：加载层级 ${t}：获取数据出错：`,e),d(e.message,t,h)}}else r?(console.log("选择器模块：层级处理单个下载项：",e),renderDownloadButtons([e],t)):l&&Array.isArray(l)?(console.log("选择器模块：层级处理多个下载项：",e),renderDownloadButtons(l,t)):(e.description||(n.innerHTML='<div class="mdui-typo"><p>此层级既无下一级数据，也无描述信息。</p></div>'),clearLevelElements(t))}(r,n+1,o),u&&u(n+1)}))})(n,e,t,o),h.appendChild(n),h.appendChild(o),function(e,t,n){if(0===t.length)return;const o=t.findIndex((e=>!0===e.default)),a=-1!==o?o:0;console.log(`选择器模块：层级 ${n}：原始索引：${o}`),console.log(`选择器模块：层级 ${n}：自动选择索引：${a}`),e.value=a.toString();const r=new Event("change",{bubbles:!0});e.dispatchEvent(r)}(n,e,t)}(n,t)}catch(e){console.error(`选择器模块：加载层级 ${t} 出错：`,e),d(e.message,t,h)}}function clearLevelElements(e){for(;h.children.length>2*e;)h.removeChild(h.lastChild)}async function fetchItems(e,t="json"){if("string"==typeof e)try{const n=await fetch(e);if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return await n[t]()}catch(e){if("TypeError"===e.name)throw new Error(`网络错误：${e.message}`);throw e}return e}async function transformDataIfNecessary(e,t){switch(t){case"Way2old":const t=function(e){return console.log(`选择器模块：Way2old线：latest：${e.latest}`),e.latest}(e);return m(e,t);case"Lemwood":const n=await async function(){const e=h.firstElementChild;if(!e||!e.selectedOptions||0===e.selectedOptions.length)return console.error("选择器模块：Lemwood线：无法获取第一个选择器的选中项"),null;let t=e.selectedOptions[0].innerText;switch(t){case"Fold Craft Launcher":t="fcl";break;case"Zalith Launcher":t="zl";break;case"Zalith Launcher 2":t="zl2";break;case"HMCL":t="hmcl";break;default:return console.warn(`选择器模块：Lemwood线：未知选择器名称：${t}`),null}const n=await fetchItems(`https://mirror.lemwood.icu/api/latest/${t}`,"text");return console.log(`选择器模块：Lemwood线：latest：${n}`),n}();return f(e,n);case"LemwoodLatest":return p(e);default:return e}}function renderDownloadButtons(e,t){console.log(`选择器模块：渲染下载按钮，数量：${e.length}`),clearLevelElements(t);const n=document.createElement("div");n.className="download-buttons-container",e.forEach((e=>{if(e.url){const t=s(e,i,o?0:a);n.appendChild(t)}})),h.appendChild(n)}function defaultCreateSelectElement(e,t){const n=document.createElement("select");n.classList.add("mdui-select","mdui-block");const o=document.createDocumentFragment(),a={};e.forEach(((e,t)=>{const n=document.createElement("option");n.value=t,n.textContent=e.name||"(无名称)";const o=e.type||"";a[o]||(a[o]=[]),a[o].push(n)}));for(const[e,t]of Object.entries(a))if(e){const n=document.createElement("optgroup");n.label=e,t.forEach((e=>n.appendChild(e))),o.appendChild(n)}else t.forEach((e=>o.appendChild(e)));return n.appendChild(o),n}function defaultCreateDescriptionElement(){const e=document.createElement("div");return e.className="description",e}function defaultCreateDownloadElement(e,t,n){const o=document.createElement("a");o.href=e.url;let a=e.name||"文件";"all 架构"===a&&(a="通用架构");const r=`下载 ${a}`;o.textContent=r,o.className="mdui-btn mdui-btn-block mdui-btn-raised mdui-ripple",o.target="_blank",o.dataset.originalText=r,o.dataset.debounceDelay=n;return o.addEventListener("click",(n=>{o.disabled?n.preventDefault():(t&&t(e,n),function(e){const t=parseInt(e.dataset.debounceDelay)||3;if(t<=0)return;let n=t;e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed",e.textContent=`请勿重复点击：${n}秒`;const o=setInterval((()=>{n--,n>0?e.textContent=`请勿重复点击：${n}秒`:(clearInterval(o),e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",e.textContent=e.dataset.originalText)}),1e3)}(o))})),o}function defaultRenderError(e,t,n){const o=document.createElement("div");o.style.color="#f00",o.textContent=`出错：${e}`,n.appendChild(o)}function defaultTransformWay2oldApiData(e,t){const n=[];return(Array.isArray(e)?e:e.children||[]).forEach((e=>{"directory"===e.type?n.push({name:e.name,description:e.description||"",children:e.children?defaultTransformWay2oldApiData(e.children,t):[],default:e.name===t}):"file"===e.type?n.push({name:e.arch+" 架构",url:e.download_link,arch:e.arch||""}):console.warn("选择器模块：转换Way2old：忽略未知类型项：",e)})),n}function defaultTransformLemwoodApiData(e,t){return e.map((e=>({name:e.name,default:e.name===t,children:e.assets?.map((e=>({name:e.name,url:e.url,size:e.size})))||[]})))}function defaultTransformLemwoodLatestApiData(e){return defaultTransformLemwoodApiData([e])}h?loadLevel(n,0):console.error(`选择器模块：找不到容器：${t}`)}