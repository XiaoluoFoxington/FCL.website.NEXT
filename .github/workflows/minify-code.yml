name: è‡ªåŠ¨å‹ç¼©ä»£ç å¹¶æ¨é€è‡³minåˆ†æ”¯

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  minify-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: å®‰è£…å‹ç¼©å·¥å…·
        run: |
          npm install -g html-minifier-terser@7.2.0 clean-css-cli@5.6.3 terser@5.26.0
          echo "âœ… å‹ç¼©å·¥å…·å®‰è£…å®Œæˆ"

      - name: åˆå§‹åŒ–distç›®å½•
        run: |
          rm -rf dist && mkdir -p dist
          echo "âœ… æ¸…ç†å¹¶é‡å»ºdistç›®å½•å®Œæˆ"

      - name: å¤„ç†æ‰€æœ‰æ–‡ä»¶
        run: |
          find . -type f \
            ! -path "./node_modules/*" \
            ! -path "./dist/*" \
            ! -path "./.git/*" | while IFS= read -r file; do
              output="dist/${file#./}"
              mkdir -p "$(dirname "$output")"

              case "$file" in
                *.html)
                  echo "ğŸ”§ å‹ç¼©HTML: $file"
                  html-minifier-terser \
                    --collapse-whitespace \
                    --remove-comments \
                    --remove-optional-tags \
                    --remove-redundant-attributes \
                    --remove-empty-elements \
                    --remove-empty-attributes \
                    --remove-script-type-attributes \
                    --remove-style-link-type-attributes \
                    -o "$output" "$file"
                  ;;
                *.css)
                  echo "ğŸ”§ å‹ç¼©CSS: $file"
                  cleancss --level 0 -o "$output" "$file"
                  ;;
                *.js)
                  echo "ğŸ”§ å‹ç¼©JS: $file"
                  terser "$file" \
                    --compress "drop_console=false,drop_debugger=false" \
                    --mangle "keep_fnames=true" \
                    --comments false \
                    -o "$output"
                  ;;
                *.json)
                  echo "ğŸ”§ å‹ç¼©JSON: $file"
                  node -e "
                    const fs = require('fs');
                    try {
                      const data = JSON.parse(fs.readFileSync('$file', 'utf8'));
                      fs.writeFileSync('$output', JSON.stringify(data));
                    } catch (e) {
                      console.error('âŒ JSONè§£æå¤±è´¥:', '$file', e.message);
                      process.exit(1);
                    }
                  "
                  ;;
                *)
                  echo "ğŸ“¤ å¤åˆ¶é™æ€èµ„æº: $file"
                  cp -f "$file" "$output"
                  ;;
              esac
            done
          echo "âœ… æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ"

      - name: æ¨é€è‡³minåˆ†æ”¯
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          if ! git show-ref --verify --quiet refs/heads/min; then
            echo "âš ï¸ minåˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºåˆ†æ”¯"
            git checkout --orphan min
            git rm -rf .
            git commit --allow-empty -m "Initial min branch"
            git push origin min
          fi

          git checkout min
          git pull origin min --rebase

          git clean -fdx --exclude=.git
          echo "âœ… minåˆ†æ”¯å·¥ä½œåŒºæ¸…ç†å®Œæˆ"

          cp -rf dist/* .
          rm -rf dist

          git add -A
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— ä»£ç å˜æ›´ï¼Œæ— éœ€æäº¤"
            exit 0
          fi

          commit_msg="Auto minify code: $(git log main -1 --pretty=format:'%s (%h)')"
          git commit -m "$commit_msg"
          git push origin min
          echo "âœ… å‹ç¼©ä»£ç å·²æ¨é€è‡³minåˆ†æ”¯"
